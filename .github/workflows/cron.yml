name: direct package repo access update
on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch: {}
jobs:
  update-archive:
    strategy:
      matrix:
        distro: [ ubuntu, debian, centos, fedora, ol, opensuse-leap ]
    name: ${{ matrix.distro }}
    runs-on: ubuntu-latest
    steps:
      - name: install required packages
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo dpkg --purge unattended-upgrades
          sudo apt-get update
          sudo apt-get install -y clang bsdutils build-essential pkgconf zlib1g-dev libdw-dev libdwarf-dev libelf-dev software-properties-common devscripts ubuntu-dev-tools

      - name: authenticate
        run: |
          gh auth login --with-token <<<'${{ secrets.DD_BTFHUB_BOT_GITHUB_TOKEN }}'

      - name: checkout btfhub
        uses: actions/checkout@v3
        with:
          ref: no-kmod
          token: ${{ secrets.DD_BTFHUB_BOT_GITHUB_TOKEN }}
          submodules: 'recursive'

      - uses: actions/setup-go@v4
        with:
          go-version-file: 'go.mod'

      - name: build pahole
        run: |
          cd ./3rdparty/dwarves
          mkdir build
          cd build
          cmake -D__LIB=lib ..
          sudo make install
          echo "/usr/local/lib" | sudo tee /etc/ld.so.conf.d/pahole.conf
          sudo ldconfig

      - name: build btfhub
        run: make

      - name: checkout btfhub-archive
        uses: actions/checkout@v3
        with:
          repository: DataDog/btfhub-archive
          ref: no-kmod
          token: ${{ secrets.DD_BTFHUB_BOT_GITHUB_TOKEN }}
          path: archive
          sparse-checkout: |
            ${{ matrix.distro }}

      - name: setup git config
        run: |
          cd archive
          git config --local user.name "Bryce Kahle"
          git config --local user.email "bryce.kahle@datadoghq.com"

      - name: generate BTFs
        run: |
          ./btfhub -workers 6 -d ${{ matrix.distro }}

      - name: check git status
        run: |
          cd archive
          git status

      - name: commit and push to btfhub-archive
        run: |
          cd archive
          git add -A
          git diff-index --quiet HEAD || git commit -m "update ${{ matrix.distro }} btfhub-archive on $(date -u +%Y-%m-%d)"
          git push || (git pull --rebase && git push)
