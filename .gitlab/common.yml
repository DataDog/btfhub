---
.github_auth:
  - export GITHUB_INSTALLATION_ID=$(vault kv get -field=installation_id kv/k8s/gitlab-runner/btfhub/github-app)
  - export GITHUB_CLIENT_ID=$(vault kv get -field=client_id kv/k8s/gitlab-runner/btfhub/github-app)
  - vault kv get -field=key_b64 kv/k8s/gitlab-runner/btfhub/github-app | base64 -d > "${GITHUB_PEM_PATH}"
  - export GH_TOKEN=$(go run ./cmd/github-auth)
  - echo '[credential "https://github.com"]' >> ~/.gitconfig
  - echo -e '\tusername = x-access-token' >> ~/.gitconfig
  - echo -e '\thelper = "cache --timeout=3600"' >> ~/.gitconfig
  - |
    set +x
    echo -e "protocol=https\nhost=github.com\nusername=x-access-token\npassword=${GH_TOKEN}" | git credential approve
